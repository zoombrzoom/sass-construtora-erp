rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return getUserData().role == 'admin';
    }
    
    // Helper function to check if user is financeiro
    function isFinanceiro() {
      return getUserData().role == 'financeiro';
    }
    
    // Helper function to check if user is engenharia
    function isEngenharia() {
      return getUserData().role == 'engenharia';
    }

    // Helper function to check if user is secretaria
    function isSecretaria() {
      return getUserData().role == 'secretaria';
    }
    
    // Helper function to check if user can access obra
    function canAccessObra(obraId) {
      let userData = getUserData();
      return isAdmin() || isFinanceiro() || isSecretaria() || (isEngenharia() && userData.obraId == obraId);
    }

    // Contas pessoais: liberamos leitura para qualquer usuario autenticado.
    // Suporta variacoes legadas (pessoal salvo como string/numero, ou obraId com variacao de caixa).
    function isContaPessoal(contaData) {
      return (
        contaData.pessoal == true ||
        contaData.pessoal == 'true' ||
        contaData.pessoal == 1 ||
        contaData.pessoal == '1' ||
        contaData.obraId == 'PESSOAL' ||
        contaData.obraId == 'Pessoal' ||
        contaData.obraId == 'pessoal'
      );
    }

    // Usuário com restrições específicas de acesso financeiro
    function isRestrictedFinanceUser() {
      return request.auth != null && (
        request.auth.token.email == 'atendimento@majollo.com.br' ||
        request.auth.token.email == 'compras@majollo.com.br'
      );
    }

    function canAccessContasParticulares() {
      return request.auth != null && (
        isAdmin() ||
        request.auth.token.email == 'atendimento@majollo.com.br'
      );
    }

    function canAccessCaixinha() {
      return request.auth != null && (
        isAdmin() ||
        isFinanceiro() ||
        isSecretaria() ||
        request.auth.token.email == 'atendimento@majollo.com.br'
      );
    }
    
    // Users collection
    match /users/{userId} {
      // Qualquer usuário autenticado pode ler seu próprio documento, admin pode ler todos
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // Usuário pode criar seu próprio documento (para setup inicial)
      allow create: if request.auth != null && request.auth.uid == userId;
      // Usuário pode atualizar seu próprio documento (ex: mudar mustChangePassword)
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // Apenas admin pode deletar
      allow delete: if isAdmin();
    }
    
    // Obras collection
    match /obras/{obraId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(obraId));
      allow create: if request.auth != null && (isAdmin() || isFinanceiro());
      allow update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }

    // Categorias de Obras (menu lateral em Obras e Gestao)
    match /obras_categorias/{categoriaId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria() || isEngenharia());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }
    
    // Contas a Pagar
    match /contasPagar/{contaId} {
      allow read: if request.auth != null && (
        // Admin e financeiro podem listar todas as contas (necessário para backup e listagens).
        isAdmin() ||
        isFinanceiro() ||
        // Qualquer usuario autenticado pode ver contas pessoais (aba Contas Pessoais).
        isContaPessoal(resource.data) ||
        (resource.data.tipo == 'particular' && canAccessContasParticulares()) ||
        (resource.data.tipo != 'particular' && canAccessObra(resource.data.obraId))
      );
      // Permite criar contas tambem para secretaria (exceto "particular", que segue restricao).
      allow create: if request.auth != null && (
        isAdmin() ||
        isFinanceiro() ||
        (isSecretaria() && request.resource.data.tipo != 'particular') ||
        (request.resource.data.tipo == 'particular' && canAccessContasParticulares())
      );
      allow update, delete: if request.auth != null && (
        isAdmin() ||
        (resource.data.tipo == 'particular' && canAccessContasParticulares()) ||
        (resource.data.tipo != 'particular' && (isFinanceiro() || isSecretaria()))
      );
    }
    
    // Contas a Receber
    match /contasReceber/{contaId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
      allow create: if request.auth != null && (isAdmin() || isFinanceiro());
      allow update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }

    // Folha de Pagamento
    match /folhaPagamento/{folhaId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
      // Secretaria também precisa poder ajustar/excluir lançamentos (fluxo real do escritório).
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
    }

    // Categorias da folha de pagamento (departamentos)
    match /folha_pagamento_categorias/{categoriaId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
    }
    
    // Requisições
    match /requisicoes/{requisicaoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
    }
    
    // Cotações
    match /cotacoes/{cotacaoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }
    
    // Pedidos de Compra
    match /pedidosCompra/{pedidoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }
    
    // Medições
    match /medicoes/{medicaoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
    }
    
    // Recebimentos
    match /recebimentos/{recebimentoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
    }
    
    // Empreiteiros
    match /empreiteiros/{empreiteiroId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }

    // Preços Regionais (histórico de preços de mercado)
    match /precos_regionais/{precoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }

    // Fornecedores
    match /fornecedores/{fornecedorId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }
    
    // Plano de Contas
    match /planoContas/{contaId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }

    // Contas Pessoais - Categorias
    match /contas_pessoais_categorias/{categoriaId} {
      allow read: if request.auth != null && !isRestrictedFinanceUser();
      allow create, update, delete: if request.auth != null && !isRestrictedFinanceUser() && (isAdmin() || isFinanceiro());
    }

    // Contas Pessoais - Lançamentos
    match /contas_pessoais_lancamentos/{lancamentoId} {
      allow read: if request.auth != null && !isRestrictedFinanceUser();
      allow create, update, delete: if request.auth != null && !isRestrictedFinanceUser() && (isAdmin() || isFinanceiro());
    }

    // Dados Bancários usados em contas a pagar
    match /dados_bancarios/{docId} {
      allow read, create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }

    // Documentos e Contratos
    match /documentos/{documentoId} {
      allow read: if request.auth != null && (
        resource.data.visibilidade != 'admin_only' ||
        isAdmin()
      );
      allow create, update, delete: if request.auth != null && (
        isAdmin() || isFinanceiro() || isSecretaria()
      );
    }

    // Pastas de Documentos
    match /documentos_pastas/{pastaId} {
      allow read: if request.auth != null && (
        resource.data.visibilidade != 'admin_only' ||
        isAdmin()
      );
      allow create, update, delete: if request.auth != null && (
        isAdmin() || isFinanceiro() || isSecretaria()
      );
    }

    // Caixinha mensal do escritório
    match /caixinha/{caixinhaId} {
      allow read, create, update, delete: if canAccessCaixinha();
    }
  }
}
