rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper: retorna os dados do usuário. Retorna null se o doc não existir (evita "Missing or insufficient permissions").
    function getUserData() {
      let doc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return (doc != null && doc.exists && doc.data != null) ? doc.data : null;
    }
    
    function getRole() {
      let d = getUserData();
      return d != null && d.get('role', null) != null ? d.get('role', '') : '';
    }
    
    function isAdmin() {
      return getRole() == 'admin';
    }
    
    function isFinanceiro() {
      return getRole() == 'financeiro';
    }
    
    function isEngenharia() {
      return getRole() == 'engenharia';
    }

    function isSecretaria() {
      return getRole() == 'secretaria';
    }
    
    function canAccessObra(obraId) {
      let userData = getUserData();
      return isAdmin() || isFinanceiro() || isSecretaria() || (isEngenharia() && userData != null && userData.get('obraId', '') == obraId);
    }

    // Contas pessoais: liberamos leitura para qualquer usuario autenticado.
    function isContaPessoal(contaData) {
      return (
        contaData.pessoal == true ||
        contaData.pessoal == 'true' ||
        contaData.pessoal == 1 ||
        contaData.pessoal == '1' ||
        contaData.obraId == 'PESSOAL' ||
        contaData.obraId == 'Pessoal' ||
        contaData.obraId == 'pessoal'
      );
    }

    function isRestrictedFinanceUser() {
      return request.auth != null && (
        request.auth.token.email == 'atendimento@majollo.com.br' ||
        request.auth.token.email == 'compras@majollo.com.br'
      );
    }

    function canAccessContasParticulares() {
      return request.auth != null && (
        isAdmin() ||
        request.auth.token.email == 'atendimento@majollo.com.br'
      );
    }

    function canAccessCaixinha() {
      return request.auth != null && (
        isAdmin() ||
        isFinanceiro() ||
        isSecretaria() ||
        request.auth.token.email == 'atendimento@majollo.com.br'
      );
    }
    
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Obras: qualquer autenticado (evita erro quando users não tem role)
    match /obras/{obraId} {
      allow read, create, update, delete: if request.auth != null;
    }

    match /obras_categorias/{categoriaId} {
      allow read, create, update, delete: if request.auth != null;
    }
    
    // Contas a Pagar: qualquer autenticado (evita lista vazia quando users não tem role)
    match /contasPagar/{contaId} {
      allow read, create, update, delete: if request.auth != null;
    }
    
    // Contas a Receber: qualquer autenticado
    match /contasReceber/{contaId} {
      allow read, create, update, delete: if request.auth != null;
    }

    match /folhaPagamento/{folhaId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
    }

    match /folha_pagamento_categorias/{categoriaId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
    }
    
    // Funcionários da folha (novo modelo): qualquer autenticado
    match /folhaFuncionarios/{funcionarioId} {
      allow read, create, update, delete: if request.auth != null;
    }
    
    match /requisicoes/{requisicaoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
    }
    
    match /cotacoes/{cotacaoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }
    
    match /pedidosCompra/{pedidoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }
    
    match /medicoes/{medicaoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
    }
    
    match /recebimentos/{recebimentoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro() || canAccessObra(resource.data.obraId));
    }
    
    match /empreiteiros/{empreiteiroId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }

    match /precos_regionais/{precoId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro() || isSecretaria());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }

    match /fornecedores/{fornecedorId} {
      allow read: if request.auth != null && (isAdmin() || isFinanceiro());
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }
    
    match /planoContas/{contaId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }

    match /contas_pessoais_categorias/{categoriaId} {
      allow read: if request.auth != null && !isRestrictedFinanceUser();
      allow create, update, delete: if request.auth != null && !isRestrictedFinanceUser() && (isAdmin() || isFinanceiro());
    }

    match /contas_pessoais_lancamentos/{lancamentoId} {
      allow read: if request.auth != null && !isRestrictedFinanceUser();
      allow create, update, delete: if request.auth != null && !isRestrictedFinanceUser() && (isAdmin() || isFinanceiro());
    }

    match /dados_bancarios/{docId} {
      allow read, create, update, delete: if request.auth != null && (isAdmin() || isFinanceiro());
    }

    // Documentos: qualquer autenticado pode ler/criar/atualizar/excluir (app controla via canManageDrive)
    match /documentos/{documentoId} {
      allow read, create, update, delete: if request.auth != null;
    }

    // Pastas de documentos: mesma regra
    match /documentos_pastas/{pastaId} {
      allow read, create, update, delete: if request.auth != null;
    }

    match /caixinha/{caixinhaId} {
      allow read, create, update, delete: if canAccessCaixinha();
    }
  }
}
